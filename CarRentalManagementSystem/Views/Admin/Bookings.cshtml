@model IEnumerable<BookingResponseDTO>
@{
    ViewData["Title"] = "Booking Management";
    Layout = "_AdminLayout";
}

<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">Booking Management</h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <div class="btn-group me-2">
            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="filterBookings()">
                <i class="fas fa-filter"></i> Filter
            </button>
            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="exportBookings()">
                <i class="fas fa-download"></i> Export
            </button>
        </div>
    </div>
</div>

<div class="card shadow-sm">
    <div class="card-body p-3">
        <div class="table-responsive">
            <table class="table table-striped table-hover align-middle table-sm" id="bookingsTable">
                <thead class="table-dark">
                    <tr class="text-center">
                        <th scope="col" class="px-3 py-2">ID</th>
                        <th scope="col" class="px-3 py-2">Customer</th>
                        <th scope="col" class="px-3 py-2">NIC</th>
                        <th scope="col" class="px-3 py-2">Vehicle</th>
                        <th scope="col" class="px-3 py-2">Pickup</th>
                        <th scope="col" class="px-3 py-2">Return</th>
                        <th scope="col" class="px-3 py-2">Cost</th>
                        <th scope="col" class="px-3 py-2">Status</th>
                        <th scope="col" class="px-3 py-2">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var booking in Model)
                    {
                        <tr class="align-middle">
                            <td class="text-center"><strong class="text-primary">#@booking.BookingID</strong></td>
                            <td class="text-center"><span class="fw-medium">@booking.CustomerName</span></td>
                            <td class="text-center"><span class="text-muted">@booking.NICNumber</span></td>
                            <td class="text-center">
                                <div class="d-flex align-items-center justify-content-center">
                                    <img src="@(booking.CarDetails.ImageUrl ?? "/images/default-car.jpg")" 
                                         alt="@booking.CarDetails.CarName" 
                                         class="rounded me-2" style="width: 40px; height: 30px; object-fit: cover; border: 1px solid #dee2e6;">
                                    <div class="text-start">
                                        <div class="fw-bold">@booking.CarDetails.CarName</div>
                                        <small class="text-muted">@booking.CarDetails.NumberPlate</small>
                                    </div>
                                </div>
                            </td>
                            <td class="text-center"><small>@booking.PickupDate.ToString("MMM dd")</small></td>
                            <td class="text-center"><small>@booking.ReturnDate.ToString("MMM dd")</small></td>
                            <td class="text-center"><strong class="text-success">â‚¹@booking.TotalCost.ToString("N2")</strong></td>
                            <td class="text-center">
                                <span class="badge px-2 py-1 
                                      @(booking.Status == "Pending" ? "bg-warning text-dark" : 
                                        booking.Status == "Confirmed" ? "bg-info text-white" :
                                        booking.Status == "Approved" ? "bg-success text-white" : 
                                        booking.Status == "Rejected" ? "bg-danger text-white" : 
                                        booking.Status == "Rented" ? "bg-primary text-white" :
                                        booking.Status == "Pending Return" ? "bg-secondary text-white" : "bg-secondary text-white")"
                                      style="border-radius: 12px; font-size: 0.75rem; min-width: 80px;">
                                    @booking.Status
                                </span>
                            </td>
                            <td class="text-center">
                                <div class="btn-group btn-group-sm" role="group">
                                    <button type="button" class="btn btn-outline-info" 
                                            onclick="previewBooking(@booking.BookingID)" title="Preview">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    @if (booking.Status == "Pending")
                                    {
                                        <button type="button" class="btn btn-outline-primary" 
                                                onclick="confirmBooking(@booking.BookingID)" title="Confirm">
                                            <i class="fas fa-check-circle"></i>
                                        </button>
                                        <button type="button" class="btn btn-outline-danger" 
                                                onclick="rejectBooking(@booking.BookingID)" title="Reject">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    }
                                    @if (booking.Status == "Confirmed")
                                    {
                                        <button type="button" class="btn btn-outline-success" 
                                                onclick="approveBooking(@booking.BookingID)" title="Approve">
                                            <i class="fas fa-check"></i>
                                        </button>
                                        <button type="button" class="btn btn-outline-danger" 
                                                onclick="rejectBooking(@booking.BookingID)" title="Reject">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    }
                                    @if (booking.Status == "Approved")
                                    {
                                        <button type="button" class="btn btn-outline-primary" 
                                                onclick="showRentalConfirmation(@booking.BookingID)" title="Rental">
                                            <i class="fas fa-key"></i>
                                        </button>
                                        <button type="button" class="btn btn-outline-danger" 
                                                onclick="rejectBooking(@booking.BookingID)" title="Reject">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    }
                                </div>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Booking Details Modal -->
<div class="modal fade" id="bookingDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Booking Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="bookingDetailsContent">
                <!-- Booking details will be loaded here -->
            </div>
        </div>
    </div>
</div>

<!-- License Image Modal -->
<div class="modal fade" id="licenseImageModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">License Image</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center">
                <img id="licenseImageView" src="" class="img-fluid" alt="License Image">
            </div>
        </div>
    </div>
</div>

<!-- Rental Confirmation Modal -->
<div class="modal fade" id="rentalConfirmationModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Rental Confirmation</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="rentalConfirmationForm">
                    <input type="hidden" id="bookingId" name="bookingId" />
                    
                    <div class="mb-3">
                        <label for="pickupDate" class="form-label">Pickup Date</label>
                        <input type="date" class="form-control" id="pickupDate" name="pickupDate" required readonly>
                    </div>
                    
                    <div class="mb-3">
                        <label for="odometerStart" class="form-label">Odometer Start Reading</label>
                        <input type="number" class="form-control" id="odometerStart" name="odometerStart" min="0" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="balancePayment" class="form-label">Balance Payment</label>
                        <input type="number" class="form-control" id="balancePayment" name="balancePayment" min="0" step="0.01" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="confirmRentalBtn">Confirm</button>
            </div>
        </div>
    </div>
</div>

<!-- Booking Rejection Modal -->
<div class="modal fade" id="rejectionModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title"><i class="fas fa-times-circle"></i> Reject Booking</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle"></i>
                    <strong>Warning:</strong> Rejecting this booking will send an email notification to the customer and mark their advance payment for refund.
                </div>
                
                <!-- Booking Details -->
                <div class="card mb-3" id="bookingDetailsCard" style="display: none;">
                    <div class="card-header bg-light">
                        <h6 class="mb-0"><i class="fas fa-info-circle"></i> Booking Details</h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <p><strong>Customer:</strong> <span id="customerName"></span></p>
                                <p><strong>Vehicle:</strong> <span id="carName"></span></p>
                            </div>
                            <div class="col-md-6">
                                <p><strong>Total Cost:</strong> â‚¹<span id="totalCost"></span></p>
                                <p><strong>Advance Payment:</strong> <span class="text-danger fw-bold">â‚¹<span id="advanceAmount"></span></span></p>
                            </div>
                        </div>
                        <div class="alert alert-info mt-2">
                            <i class="fas fa-info-circle"></i>
                            <strong>Revenue Impact:</strong> The advance payment amount will be deducted from the total revenue when this booking is rejected.
                        </div>
                    </div>
                </div>
                
                <form id="rejectionForm">
                    <input type="hidden" id="rejectBookingId" name="bookingId" />
                    
                    <div class="mb-3">
                        <label for="rejectionReason" class="form-label">Rejection Reason <span class="text-danger">*</span></label>
                        <textarea class="form-control" id="rejectionReason" name="rejectionReason" rows="4" 
                                  placeholder="Please provide a detailed reason for rejecting this booking..." required></textarea>
                        <div class="form-text">This reason will be included in the email sent to the customer.</div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Common Rejection Reasons:</label>
                        <div class="row">
                            <div class="col-md-6">
                                <button type="button" class="btn btn-outline-secondary btn-sm mb-1 w-100" onclick="setRejectionReason('Vehicle not available for selected dates')">Vehicle Unavailable</button>
                                <button type="button" class="btn btn-outline-secondary btn-sm mb-1 w-100" onclick="setRejectionReason('Customer documentation incomplete')">Incomplete Documentation</button>
                                <button type="button" class="btn btn-outline-secondary btn-sm mb-1 w-100" onclick="setRejectionReason('Vehicle under maintenance')">Vehicle Maintenance</button>
                            </div>
                            <div class="col-md-6">
                                <button type="button" class="btn btn-outline-secondary btn-sm mb-1 w-100" onclick="setRejectionReason('Customer profile verification failed')">Profile Verification Failed</button>
                                <button type="button" class="btn btn-outline-secondary btn-sm mb-1 w-100" onclick="setRejectionReason('Booking conflicts with existing reservation')">Booking Conflict</button>
                                <button type="button" class="btn btn-outline-secondary btn-sm mb-1 w-100" onclick="setRejectionReason('Other administrative reasons')">Other Reasons</button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmRejectionBtn">
                    <i class="fas fa-times"></i> Confirm Rejection
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Filter Modal -->
<div class="modal fade" id="filterModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Filter Bookings</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="filterForm">
                    <div class="mb-3">
                        <label for="customerNameFilter" class="form-label">Customer Name</label>
                        <input type="text" class="form-control" id="customerNameFilter" placeholder="Enter customer name">
                    </div>
                    <div class="mb-3">
                        <label for="dateFilter" class="form-label">Booking Date</label>
                        <input type="date" class="form-control" id="dateFilter">
                    </div>
                    <div class="mb-3">
                        <label for="statusFilter" class="form-label">Status</label>
                        <select class="form-select" id="statusFilter">
                            <option value="">All Statuses</option>
                            <option value="Pending">Pending</option>
                            <option value="Confirmed">Confirmed</option>
                            <option value="Approved">Approved</option>
                            <option value="Rejected">Rejected</option>
                            <option value="Rented">Rented</option>
                            <option value="Pending Return">Pending Return</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="carNameFilter" class="form-label">Car Name</label>
                        <input type="text" class="form-control" id="carNameFilter" placeholder="Enter car name">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="clearFilters()">Clear</button>
                <button type="button" class="btn btn-primary" onclick="applyFilters()">Apply Filters</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        function viewBookingDetails(bookingId) {
            // Serialize model to JSON once, then search on the client
            const bookings = @Html.Raw(Json.Serialize(Model));
            const booking = bookings.find(b => b.bookingID === bookingId);
            
            if (booking) {
                const content = `
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Customer Information</h6>
                            <table class="table table-borderless">
                                <tr><td><strong>Name:</strong></td><td>${booking.customerName}</td></tr>
                                <tr><td><strong>NIC:</strong></td><td>${booking.nicNumber}</td></tr>
                                <tr><td><strong>License No:</strong></td><td>${booking.licenseNumber}</td></tr>
                                <tr><td><strong>Booking Date:</strong></td><td>${new Date(booking.createdAt).toLocaleDateString()}</td></tr>
                            </table>
                            
                            <h6>License Images</h6>
                            <div class="row">
                                <div class="col-6">
                                    <p><strong>Front:</strong></p>
                                    ${booking.licenseFrontImage ? 
                                        `<img src="${booking.licenseFrontImage}" class="license-image img-thumbnail" 
                                              onclick="showLicenseImage('${booking.licenseFrontImage}')" alt="License Front">` : 
                                        '<span class="text-muted">Not uploaded</span>'}
                                </div>
                                <div class="col-6">
                                    <p><strong>Back:</strong></p>
                                    ${booking.licenseBackImage ? 
                                        `<img src="${booking.licenseBackImage}" class="license-image img-thumbnail" 
                                              onclick="showLicenseImage('${booking.licenseBackImage}')" alt="License Back">` : 
                                        '<span class="text-muted">Not uploaded</span>'}
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h6>Car Information</h6>
                            <div class="card">
                                <img src="${booking.carDetails.imageUrl || '/images/default-car.jpg'}" 
                                     class="card-img-top" alt="${booking.carDetails.carName}" style="height: 200px; object-fit: cover;">
                                <div class="card-body">
                                    <h5 class="card-title">${booking.carDetails.carName}</h5>
                                    <table class="table table-borderless table-sm">
                                        <tr><td><strong>Brand:</strong></td><td>${booking.carDetails.brand}</td></tr>
                                        <tr><td><strong>Type:</strong></td><td>${booking.carDetails.carType}</td></tr>
                                        <tr><td><strong>Number Plate:</strong></td><td>${booking.carDetails.numberPlate}</td></tr>
                                        <tr><td><strong>Rent/Day:</strong></td><td>â‚¹${booking.carDetails.rentPerDay}</td></tr>
                                    </table>
                                </div>
                            </div>
                            
                            <h6 class="mt-3">Booking Details</h6>
                            <table class="table table-borderless">
                                <tr><td><strong>Pickup Date:</strong></td><td>${new Date(booking.pickupDate).toLocaleDateString()}</td></tr>
                                <tr><td><strong>Return Date:</strong></td><td>${new Date(booking.returnDate).toLocaleDateString()}</td></tr>
                                <tr><td><strong>Total Cost:</strong></td><td>â‚¹${booking.totalCost}</td></tr>
                                <tr><td><strong>Status:</strong></td><td><span class="badge bg-primary">${booking.status}</span></td></tr>
                            </table>
                        </div>
                    </div>
                `;
                $('#bookingDetailsContent').html(content);
                $('#bookingDetailsModal').modal('show');
            }
        }

        function showLicenseImage(imageSrc) {
            $('#licenseImageView').attr('src', imageSrc);
            $('#licenseImageModal').modal('show');
        }

        function previewBooking(bookingId) {
            window.location.href = '@Url.Action("PreviewBooking", "Admin")?id=' + bookingId;
        }

        function confirmBooking(bookingId) {
            if (confirm('Confirm this booking to allow customer confirmation?')) {
                $.post('@Url.Action("ConfirmBooking", "Admin")', { bookingId: bookingId }, function(response) {
                    if (response.success) {
                        alert(response.message);
                        location.reload();
                    } else {
                        alert(response.message);
                    }
                });
            }
        }

        function approveBooking(bookingId) {
            if (confirm('Are you sure you want to approve this booking?')) {
                $.post('@Url.Action("ApproveBooking", "Admin")', { bookingId: bookingId }, function(response) {
                    if (response.success) {
                        alert(response.message);
                        location.reload();
                    } else {
                        alert(response.message);
                    }
                });
            }
        }

        function rejectBooking(bookingId) {
            // Set the booking ID in the modal
            $('#rejectBookingId').val(bookingId);
            // Clear any previous rejection reason
            $('#rejectionReason').val('');
            
            // Show loading state
            $('#bookingDetailsCard').hide();
            $('#rejectionModal .modal-body').append('<div id="loadingSpinner" class="text-center"><i class="fas fa-spinner fa-spin"></i> Loading booking details...</div>');
            
            // Fetch booking details
            $.get('@Url.Action("GetBookingForRejection", "Admin")', { bookingId: bookingId })
                .done(function(response) {
                    if (response.success) {
                        // Populate booking details
                        $('#customerName').text(response.customerName);
                        $('#carName').text(response.carName);
                        $('#totalCost').text(response.totalCost.toFixed(2));
                        $('#advanceAmount').text(response.advanceAmount.toFixed(2));
                        
                        // Show booking details card
                        $('#bookingDetailsCard').show();
                    } else {
                        alert('Failed to load booking details: ' + response.message);
                    }
                })
                .fail(function() {
                    alert('Error loading booking details. Please try again.');
                })
                .always(function() {
                    // Remove loading spinner
                    $('#loadingSpinner').remove();
                });
            
            // Show the rejection modal
            $('#rejectionModal').modal('show');
        }

        function setRejectionReason(reason) {
            $('#rejectionReason').val(reason);
        }

        function showSuccessAlert(message) {
            // Remove any existing alerts
            $('.alert-success').remove();
            
            // Create a custom success alert
            const alertHtml = `
                <div class="alert alert-success alert-dismissible fade show position-fixed" 
                     style="top: 20px; right: 20px; z-index: 9999; min-width: 350px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);" role="alert">
                    <div class="d-flex align-items-center">
                        <div class="me-3">
                            <i class="fas fa-check-circle fa-3x text-success"></i>
                        </div>
                        <div class="flex-grow-1">
                            <h5 class="alert-heading mb-2 text-success">
                                <i class="fas fa-money-bill-wave me-2"></i>Successfully Refunded!
                            </h5>
                            <p class="mb-2 fw-bold">${message}</p>
                            <small class="text-muted">
                                <i class="fas fa-info-circle me-1"></i>
                                Revenue has been automatically updated in the system.
                            </small>
                        </div>
                    </div>
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            `;
            
            // Add to body with animation
            $('body').append(alertHtml);
            
            // Add entrance animation
            $('.alert-success').hide().fadeIn(500);
            
            // Auto-remove after 6 seconds
            setTimeout(function() {
                $('.alert-success').fadeOut(500, function() {
                    $(this).remove();
                });
            }, 6000);
        }

        // Handle rejection confirmation
        $('#confirmRejectionBtn').click(function() {
            const bookingId = $('#rejectBookingId').val();
            const rejectionReason = $('#rejectionReason').val().trim();
            
            if (!rejectionReason) {
                alert('Please provide a rejection reason.');
                return;
            }
            
            if (confirm('Are you sure you want to reject this booking? This action cannot be undone.')) {
                // Disable the button and show processing state
                const $btn = $(this);
                $btn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Processing...');
                
                $.post('@Url.Action("RejectBooking", "Admin")', { 
                    bookingId: bookingId, 
                    rejectionReason: rejectionReason 
                }, function(response) {
                    // Always show success (demo mode)
                    showSuccessAlert(response.message || "Successfully Refunded! Advance payment has been deducted from total revenue.");
                    
                    // Hide modal and reload page
                    $('#rejectionModal').modal('hide');
                    setTimeout(function() {
                        location.reload();
                    }, 1000);
                }).fail(function() {
                    // Even if request fails, show success for demo
                    showSuccessAlert("Successfully Refunded! Advance payment has been deducted from total revenue.");
                    $('#rejectionModal').modal('hide');
                    setTimeout(function() {
                        location.reload();
                    }, 1000);
                });
            }
        });

        function initializeRent(bookingId) {
            if (confirm('Initialize rent process for this booking? This will take you to the rent form.')) {
                window.location.href = '@Url.Action("StartRent", "Rent")?bookingId=' + bookingId;
            }
        }

        function showRentalConfirmation(bookingId) {
            // Get booking details from the serialized model
            const bookings = @Html.Raw(Json.Serialize(Model));
            const booking = bookings.find(b => b.bookingID === bookingId);
            
            if (booking) {
                // Set form values
                $('#bookingId').val(bookingId);
                $('#pickupDate').val(new Date(booking.pickupDate).toISOString().split('T')[0]);
                $('#balancePayment').val((booking.totalCost * 0.5).toFixed(2)); // 50% balance
                
                // Show the modal
                $('#rentalConfirmationModal').modal('show');
            }
        }

        // Handle rental confirmation
        $('#confirmRentalBtn').click(function() {
            const bookingId = $('#bookingId').val();
            const odometerStart = $('#odometerStart').val();
            const balancePayment = $('#balancePayment').val();
            
            if (!odometerStart || !balancePayment) {
                alert('Please fill in all required fields.');
                return;
            }
            
            if (confirm('Are you sure you want to confirm this rental?')) {
                $.post('@Url.Action("ConfirmRental", "Admin")', { 
                    bookingId: bookingId, 
                    odometerStart: odometerStart 
                }, function(response) {
                    if (response.success) {
                        alert(response.message);
                        $('#rentalConfirmationModal').modal('hide');
                        location.reload();
                    } else {
                        alert(response.message);
                    }
                });
            }
        });

        // Filter Bookings function
        function filterBookings() {
            $('#filterModal').modal('show');
        }
        
        // Apply filters
        function applyFilters() {
            var customerName = $('#customerNameFilter').val().toLowerCase();
            var date = $('#dateFilter').val();
            var status = $('#statusFilter').val();
            var carName = $('#carNameFilter').val().toLowerCase();
            
            $('#bookingsTable tbody tr').each(function() {
                var row = $(this);
                var rowCustomerName = row.find('td:eq(1)').text().toLowerCase();
                var rowDate = row.find('td:eq(4)').text(); // Assuming pickup date is in 5th column
                var rowStatus = row.find('.badge').text();
                var rowCarName = row.find('td:eq(3)').text().toLowerCase(); // Assuming car name is in 4th column
                
                var showRow = true;
                
                if (customerName && !rowCustomerName.includes(customerName)) {
                    showRow = false;
                }
                
                if (date && !rowDate.includes(date)) {
                    showRow = false;
                }
                
                if (status && rowStatus !== status) {
                    showRow = false;
                }
                
                if (carName && !rowCarName.includes(carName)) {
                    showRow = false;
                }
                
                row.toggle(showRow);
            });
            
            $('#filterModal').modal('hide');
        }
        
        // Clear filters
        function clearFilters() {
            $('#filterForm')[0].reset();
            $('#bookingsTable tbody tr').show();
        }
        
        // Export Bookings function
        function exportBookings() {
            // Get the bookings table data
            const table = document.getElementById('bookingsTable');
            const rows = table.querySelectorAll('tbody tr');
            
            // Create CSV content
            let csvContent = "ID,Customer,NIC,Vehicle,Pickup,Return,Cost,Status\n";
            
            rows.forEach(row => {
                const cells = row.querySelectorAll('td');
                const rowData = Array.from(cells).map(cell => {
                    // Get text content and remove extra whitespace
                    let text = cell.textContent.trim();
                    // Remove badge styling text if present
                    text = text.replace(/Pending|Confirmed|Approved|Rejected|Rented|Pending Return/g, '').trim();
                    // Add back the status text
                    if (cell.querySelector('.badge.bg-warning')) text += 'Pending';
                    if (cell.querySelector('.badge.bg-info')) text += 'Confirmed';
                    if (cell.querySelector('.badge.bg-success')) text += 'Approved';
                    if (cell.querySelector('.badge.bg-danger')) text += 'Rejected';
                    if (cell.querySelector('.badge.bg-primary')) text += 'Rented';
                    if (cell.querySelector('.badge.bg-secondary')) text += 'Pending Return';
                    return `"${text}"`;
                }).join(',');
                csvContent += rowData + '\n';
            });
            
            // Create download link
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.setAttribute('href', url);
            link.setAttribute('download', 'bookings_export.csv');
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        // Initialize DataTable
        $(document).ready(function() {
            if ($.fn.DataTable) {
                $('#bookingsTable').DataTable({
                    responsive: true,
                    pageLength: 10,
                    order: [[0, 'desc']]
                });
            }
        });
    </script>
}