@model BookingResponseDTO
@{
    ViewData["Title"] = "Payment";
}

<div class="container">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card shadow">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0"><i class="fas fa-credit-card"></i> Payment Processing</h4>
                </div>
                <div class="card-body">
                    <!-- Booking Summary -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <h5>Booking Summary</h5>
                            <div class="card bg-light">
                                <div class="card-body">
                                    <p><strong>Booking ID:</strong> #@Model.BookingID</p>
                                    <p><strong>Car:</strong> @Model.CarDetails.CarName</p>
                                    <p><strong>Pickup Date:</strong> @Model.PickupDate.ToString("MMM dd, yyyy")</p>
                                    <p><strong>Return Date:</strong> @Model.ReturnDate.ToString("MMM dd, yyyy")</p>
                                    <p><strong>Total Cost:</strong> ₹@Model.TotalCost</p>
                                    <p><strong>Advance Payment (50%):</strong> <span class="text-primary fw-bold">₹@ViewBag.Amount</span></p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h5>Car Details</h5>
                            <div class="card">
                                <img src="@(Model.CarDetails.ImageUrl ?? "/images/default-car.jpg")" 
                                     class="card-img-top" alt="@Model.CarDetails.CarName" 
                                     style="height: 200px; object-fit: cover;">
                                <div class="card-body">
                                    <h6 class="card-title">@Model.CarDetails.CarName</h6>
                                    <p class="card-text">
                                        <small class="text-muted">
                                            @Model.CarDetails.Brand • @Model.CarDetails.NumberPlate
                                        </small>
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Payment Form -->
                    <div class="row">
                        <div class="col-12">
                            <h5>Payment Information</h5>
                            
                            <!-- Demo Payment Notice -->
                            <div class="alert alert-warning mb-3">
                                <i class="fas fa-info-circle"></i>
                                <strong>Demo Mode:</strong> Use test card number <code>4242 4242 4242 4242</code> with any future expiry date and CVV for testing.
                            </div>
                            
                            <form id="payment-form">
                                <div class="mb-3">
                                    <label class="form-label">Cardholder Name</label>
                                    <input type="text" class="form-control" id="card-holder-name" placeholder="John Doe" required>
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label">Card Number</label>
                                    <input type="text" class="form-control" id="card-number" placeholder="4242 4242 4242 4242" maxlength="19" required>
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-4 mb-3">
                                        <label class="form-label">Expiry Month</label>
                                        <select class="form-select" id="expiry-month" required>
                                            <option value="">Month</option>
                                            <option value="01">01</option>
                                            <option value="02">02</option>
                                            <option value="03">03</option>
                                            <option value="04">04</option>
                                            <option value="05">05</option>
                                            <option value="06">06</option>
                                            <option value="07">07</option>
                                            <option value="08">08</option>
                                            <option value="09">09</option>
                                            <option value="10">10</option>
                                            <option value="11">11</option>
                                            <option value="12">12</option>
                                        </select>
                                    </div>
                                    <div class="col-md-4 mb-3">
                                        <label class="form-label">Expiry Year</label>
                                        <select class="form-select" id="expiry-year" required>
                                            <option value="">Year</option>
                                            <option value="2024">2024</option>
                                            <option value="2025">2025</option>
                                            <option value="2026">2026</option>
                                            <option value="2027">2027</option>
                                            <option value="2028">2028</option>
                                            <option value="2029">2029</option>
                                        </select>
                                    </div>
                                    <div class="col-md-4 mb-3">
                                        <label class="form-label">CVV</label>
                                        <input type="text" class="form-control" id="cvv" placeholder="123" maxlength="4" required>
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="terms" required>
                                        <label class="form-check-label" for="terms">
                                            I agree to the <a href="#" target="_blank">Terms and Conditions</a>
                                        </label>
                                    </div>
                                </div>

                                <div class="d-grid gap-2">
                                    <button type="submit" id="submit-payment" class="btn btn-primary btn-lg">
                                        <i class="fas fa-lock"></i> Pay ₹@ViewBag.Amount Securely
                                    </button>
                                    <a href="@Url.Action("MyBookings", "Booking")" class="btn btn-outline-secondary">
                                        <i class="fas fa-arrow-left"></i> Back to Bookings
                                    </a>
                                </div>
                            </form>
                        </div>
                    </div>

                    <!-- Security Info -->
                    <div class="row mt-4">
                        <div class="col-12">
                            <div class="alert alert-info">
                                <i class="fas fa-shield-alt"></i>
                                <strong>Secure Payment:</strong> Your payment information is encrypted and secure. 
                                We use Stripe for payment processing and do not store your card details.
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // Format card number input
        document.getElementById('card-number').addEventListener('input', function(e) {
            let value = e.target.value.replace(/\s+/g, '').replace(/[^0-9]/gi, '');
            let formattedValue = value.match(/.{1,4}/g)?.join(' ') || value;
            e.target.value = formattedValue;
        });

        // Handle form submission
        const form = document.getElementById('payment-form');
        form.addEventListener('submit', async function(event) {
            event.preventDefault();

            const submitButton = document.getElementById('submit-payment');
            submitButton.disabled = true;
            submitButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';

            try {
                // Get form data
                const cardNumber = document.getElementById('card-number').value.replace(/\s/g, '');
                const cardHolderName = document.getElementById('card-holder-name').value;
                const expiryMonth = document.getElementById('expiry-month').value;
                const expiryYear = document.getElementById('expiry-year').value;
                const cvv = document.getElementById('cvv').value;

                // Validate form
                if (!cardNumber || !cardHolderName || !expiryMonth || !expiryYear || !cvv) {
                    alert('Please fill in all payment information.');
                    resetButton();
                    return;
                }

                // Create payment intent
                const response = await fetch('@Url.Action("CreatePaymentIntent")', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value || ''
                    },
                    body: JSON.stringify({
                        BookingID: @ViewBag.BookingId,
                        Amount: @ViewBag.Amount,
                        PaymentType: 'Advance',
                        CardNumber: cardNumber,
                        CardHolderName: cardHolderName,
                        ExpiryMonth: expiryMonth,
                        ExpiryYear: expiryYear,
                        CVV: cvv
                    })
                });

                const result = await response.json();

                if (result.success) {
                    // Check if this is a demo payment
                    if (result.clientSecret.startsWith('pi_demo_')) {
                        // Demo payment - automatically confirm
                        showSuccessAndRedirect(result.clientSecret);
                    } else {
                        // Real Stripe payment - redirect to confirmation
                        window.location.href = '@Url.Action("ConfirmPayment")' + '?paymentIntentId=' + result.clientSecret;
                    }
                } else {
                    alert(result.message || 'Payment failed. Please try again.');
                    resetButton();
                }
            } catch (error) {
                console.error('Payment error:', error);
                alert('An error occurred during payment processing.');
                resetButton();
            }
        });

        function resetButton() {
            const submitButton = document.getElementById('submit-payment');
            submitButton.disabled = false;
            submitButton.innerHTML = '<i class="fas fa-lock"></i> Pay ₹@ViewBag.Amount Securely';
        }

        function showSuccessAndRedirect(paymentIntentId) {
            // Show success message
            alert('Payment successful! Your booking has been confirmed.');
            
            // Redirect to customer dashboard instead of booking confirmation
            window.location.href = '@Url.Action("Dashboard", "Customer")';
        }

        // Auto-fill demo card for testing
        document.addEventListener('DOMContentLoaded', function() {
            // Pre-fill demo data for easier testing
            document.getElementById('card-number').value = '4242 4242 4242 4242';
            document.getElementById('card-holder-name').value = 'John Doe';
            document.getElementById('expiry-month').value = '12';
            document.getElementById('expiry-year').value = '2025';
            document.getElementById('cvv').value = '123';
        });
    </script>
}